<!DOCTYPE html>
<html lang="en-us"
  dir="ltr">

  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width"><meta name="description" content="" />

<title>
    
    Liquid Level Controller | Hi Blog!
    
</title>












<link rel="stylesheet" href="/assets/combined.min.a6824bbee0d90d5af09fed9b70395ce7076b615e315037455d903314e96ef91b.css" media="all">



  </head>

  

  
  
  

  <body class="auto">

    <div class="content">
      <header>
        

<div class="header">

    

    <h1 class="header-title">Hi Blog!</h1>

    <div class="flex">
        

        
        
        <p class="small ">
            <a href="/">
                /home
            </a>
        </p>
        
        <p class="small ">
            <a href="/posts">
                /posts
            </a>
        </p>
        
        <p class="small ">
            <a href="/about">
                /about
            </a>
        </p>
        
        
    </div>

    

</div>
      </header>

      <main class="main">
        





<div >

  <div class="single-intro-container">

    

    <h1 class="single-title">Liquid Level Controller</h1>
    

    

    <p class="single-readtime">
      
      
      
      <time datetime="2024-07-15T15:33:16-07:00">July 15, 2024</time>
      

      
    </p>

  </div>

  

  

  

  

  <div class="single-content">
    <h2 id="abstract">Abstract</h2>
<p>Create a simple water level control system designed to maintain a consistent water level in a tank using a comibation of hardware and software.
Water leaves the tank through a hole at the bottom, and a pump with variable flow rate replenishs it. Other disturbances to the level, such as
water being poured in, should also be handled. To do this a liquied level sensor constantly monitors the water level. The reading it gives is
sent to an <strong>Arduino</strong>, which runs a <strong>PID</strong> (Proportional-Integral-Derivative) control algorithm. The PID controller calculates the difference
between the desired water level (setpoint) and the actual water level; then it determines the appropriate flow rate the submersible pump should
be at to minimize the error. A pulse-width modulation (PWN) signal is then sent to the pump, which increases the flow rate if the level is
below the setpoint and decreases the flow rate if it is above.</p>
<p>//insert demo picture here</p>
<h2 id="parameters">Parameters</h2>
<p>Now that you have a decent idea of the system we can discuss the many parameters that affect how quickly the system is able to return to the desired water level.</p>
<h2 id="setting-up-the-experiement">Setting up the experiement</h2>
<p>Wiring up the experiment may seem daunting but we&rsquo;ll walk through the process step by step.</p>
<h2 id="the-code">The code</h2>
<p>All arduino programs (called sketches) has two functions: a <code>setup() </code>, which runs once to <em>setup</em> variables and and a <code>loop()</code>, which does precisely what its name suggests, and <em>loops</em> consecutively. Code outside those two functions will be just like any other C/C++ program, but to keep it simple we just used it to include libraries, initalize global variables and instantiate classes. Check out more infomation on basic Arduino sketches and load other of information <a href="https://docs.arduino.cc/learn/programming/sketches/">here</a>.</p>
<p>Let&rsquo;s get started! We&rsquo;ll work from top to bottom to avoid confusion.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#728e00">#include</span> <span style="color:#728e00">&lt;PID_v1.h&gt;</span><span style="color:#728e00">
</span></span></span><span style="display:flex;"><span><span style="color:#728e00"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">double</span> <span style="color:#434f54">sensorValue</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">double</span> <span style="color:#434f54">output</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">String</span> <span style="color:#434f54">input</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">int</span> <span style="color:#434f54">outputPin</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">3</span>; <span style="color:#95a5a6">//Digital output PMW pin connection
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#00979d">int</span> <span style="color:#434f54">sensorPin</span> <span style="color:#728e00">=</span> <span style="color:#434f54">A0</span>; <span style="color:#95a5a6">//Analog sensor pin connection
</span></span></span></code></pre></div><p>First we include the PID library, which will do all the PID related calculations for us. Then, we need to declare some variables: two decimals
(double) to store the reading the level sensor gives and what the PWM should be set to, a string to hold whatever gets entered into the serial
monitor, and two numbers that describe what pin is doing what on the physical board.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#728e00">/</span><span style="color:#434f54">_</span><span style="color:#728e00">---------------</span><span style="color:#434f54">Tuning</span> <span style="color:#434f54">Variables</span><span style="color:#728e00">---------------</span><span style="color:#434f54">_</span><span style="color:#728e00">/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">double</span> <span style="color:#434f54">Kp</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">50</span>; <span style="color:#95a5a6">//Proportional Gain
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#00979d">double</span> <span style="color:#434f54">Ki</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">1</span>; <span style="color:#95a5a6">//Integral Constant
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#00979d">double</span> <span style="color:#434f54">Kd</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">0</span>; <span style="color:#95a5a6">//Derivative Constant
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#00979d">double</span> <span style="color:#434f54">level</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">6</span>; <span style="color:#95a5a6">//Set Point (3-12 cm)
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#728e00">/</span><span style="color:#434f54">_</span><span style="color:#728e00">---------------</span><span style="color:#434f54">Tuning</span> <span style="color:#434f54">Variables</span><span style="color:#728e00">---------------</span><span style="color:#434f54">_</span><span style="color:#728e00">/</span>
</span></span></code></pre></div><p>double setPoint = 19.5 * (level) + 462; //Internal setPoint
PID myPID(&amp;sensorValue, &amp;output, &amp;setPoint, Kp, Ki, Kd, DIRECT);</p>
<p>Next we have the 3 PID variables, as well as the level we want the water to remain, all stored as decimal numbers. Underneath those lines, we do
a conversion to express the desired water level we set earlier to units that match the level sensor’s output. Last we instantiate (create) a
version of the PID class and include the addresses of all the variables we created as arguments.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#00979d">void</span> <span style="color:#d35400">setup</span> (){
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Serial</span>.<span style="color:#434f54">begin</span>(<span style="color:#8a7b52">9600</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">pinMode</span>(<span style="color:#434f54">outputPin</span>, <span style="color:#434f54">OUTPUT</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">pinMode</span>(<span style="color:#434f54">sensorPin</span>, <span style="color:#434f54">INPUT</span>);  
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">myPID</span>.<span style="color:#434f54">SetMode</span>(<span style="color:#434f54">AUTOMATIC</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">myPID</span>.<span style="color:#434f54">SetOutputLimits</span>(<span style="color:#8a7b52">128</span>,<span style="color:#8a7b52">255</span>);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>Our setup function only requires a few things. We need to start the serial monitor so we can visualize whatever data we need and input our desired level. Then we can use the built in pinMode function to tell the Arduino whether the pin should be reading data or writing data, using our variables from earlier. We also want to tell the PID class to adjust our output automatically, and set the limits of the output to correspond with a PWM signal, which ranges from 128 to 255. The lower bound is 128 not 0 because the pump motor won’t turn on under that value, and since water is constantly leaving the cup, the pump should always be on.</p>
<p>Now to the meat of the program, the loop function.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#00979d">void</span> <span style="color:#d35400">loop</span> (){
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">/</span><span style="color:#434f54">_</span><span style="color:#728e00">---------------</span><span style="color:#434f54">PID</span> <span style="color:#434f54">Control</span><span style="color:#728e00">---------------</span><span style="color:#434f54">_</span><span style="color:#728e00">/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">sensorValue</span> <span style="color:#728e00">=</span> <span style="color:#434f54">analogRead</span>(<span style="color:#434f54">sensorPin</span>); <span style="color:#95a5a6">//Read the value from the sensor
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">myPID</span>.<span style="color:#434f54">Compute</span>(); <span style="color:#95a5a6">//PID computes output PWM
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">analogWrite</span>(<span style="color:#434f54">outputPin</span>, <span style="color:#434f54">output</span>); <span style="color:#95a5a6">//Update PWM output value
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">level</span> <span style="color:#728e00">=</span> (<span style="color:#434f54">sensorValue</span> <span style="color:#728e00">-</span> <span style="color:#8a7b52">462</span>) <span style="color:#728e00">/</span> <span style="color:#8a7b52">19.5</span>; <span style="color:#95a5a6">//Convert sensor value to liquid level
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">/*---------------Input Setpoint---------------*/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">//read and trim from serial input
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#434f54">input</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Serial</span>.<span style="color:#434f54">readString</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">input</span>.<span style="color:#434f54">trim</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">//set value for setpoint
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#728e00">if</span>(<span style="color:#434f54">input</span>.<span style="color:#434f54">toFloat</span>()){
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">if</span>(<span style="color:#434f54">input</span>.<span style="color:#434f54">toFloat</span>() <span style="color:#728e00">&gt;=</span> <span style="color:#8a7b52">3</span> <span style="color:#728e00">&amp;&amp;</span> <span style="color:#434f54">input</span>.<span style="color:#434f54">toFloat</span>() <span style="color:#728e00">&lt;=</span> <span style="color:#8a7b52">12</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#434f54">setPoint</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">19.5</span> <span style="color:#728e00">*</span> (<span style="color:#434f54">input</span>.<span style="color:#434f54">toFloat</span>()) <span style="color:#728e00">+</span> <span style="color:#8a7b52">462</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><p>The first part of the loop all enables the feature to set the desired level through the serial monitor. There are quite a few built in functions to help us with this. We read the input as a string and trim all the extra space before/after. Then,</p>

    
  </div>

  

  

  

  
  <div class="back-to-top">
    <a href="#top">
      back to top
    </a>
  </div>
  

</div>


      </main>
    </div>

    <footer>
      <p>Powered by
    <a href="https://gohugo.io/">Hugo</a>
    and
    <a href="https://github.com/tomfran/typo">tomfran/typo</a>
</p>


    </footer>

  </body>

  <script>

  function isAuto() {
    return document.body.classList.contains("auto");
  }

  function setTheme() {
    if (!isAuto()) {
      return
    }

    document.body.classList.remove("auto");
    let cls = "light";
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      cls = "dark";
    }

    document.body.classList.add(cls);
  }

  function invertBody() {
    document.body.classList.toggle("dark");
    document.body.classList.toggle("light");
  }

  if (isAuto()) {
    window.matchMedia('(prefers-color-scheme: dark)').addListener(invertBody);
  }

  setTheme();

</script>

</html>